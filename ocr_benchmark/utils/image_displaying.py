import matplotlib.pyplot as plt
import matplotlib.patches as patches

from PIL import Image
from typing import List, Union

def result_display(image_path: str, boxes: List[List[Union[int, float]]], annotations: List[str], predictions: List[List[int]]) -> None:
    """
    The purpose of this function is to display an image with predicted labels
    and bounding boxes overlaid, showing the results of the LayoutLMv2 model.

    Arguments:
        - image_path: str: The path to the image file to be displayed.
        - boxes: List[List[Union[int, float]]]: A list of bounding boxes for each token, 
          where each box is defined by coordinates normalized between 0 and 1000.
        - annotations: List[str]: The list of tokens or words corresponding to each bounding box.
        - predictions: List[List[int]]: The predicted labels for each token generated by the LayoutLMv2 model.

    Returns:
        None. This function displays the image with bounding boxes and labels using matplotlib.

    Notes:
        - The image is resized to a maximum of 1000x1000 pixels for display.
        - The bounding boxes, which are normalized between 0 and 1000, are scaled to match the image dimensions.
        - Bounding boxes are color-coded according to their predicted labels: blue for headers, green for questions, orange for answers, and black for other tokens.
    """
    
    image = Image.open(image_path)

    max_size = (1000, 1000)  
    image.thumbnail(max_size, Image.ANTIALIAS)

    image_width, image_height = image.size

    id2label = {0: 'O', 1: 'B-HEADER', 2: 'I-HEADER', 3: 'B-QUESTION', 4: 'I-QUESTION', 5: 'B-ANSWER', 6: 'I-ANSWER'}
    label2color = {'HEADER': 'blue', 'QUESTION': 'green', 'ANSWER': 'orange', 'O': 'black'}

    scaled_boxes = [(int(box[0] / 1000 * image_width), 
                    int(box[1] / 1000 * image_height), 
                    int(box[2] / 1000 * image_width), 
                    int(box[3] / 1000 * image_height)) for box in boxes]

    _, ax = plt.subplots(1, figsize=(image_width / 100, image_height / 100))  
    ax.imshow(image)

    for _, box, label_id in zip(annotations, scaled_boxes, predictions[0].tolist()):
        label = id2label[label_id]
        label_class = label.split('-')[-1] if '-' in label else label
        color = label2color.get(label_class, 'red')

        rect = patches.Rectangle((box[0], box[1]), box[2] - box[0], box[3] - box[1], linewidth=2, edgecolor=color, facecolor='none')
        ax.add_patch(rect)

        plt.text(box[0], box[1] - 10, label, color=color, fontsize=12, bbox=dict(facecolor='white', alpha=0.5))

    plt.show()
